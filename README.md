# 钉钉通过模式助手应用

这是一个使用 Python 开发的钉钉通过模式助手应用示例。通过模式允许您自定义处理用户的查询，并返回定制化的回复。

## 项目结构

```
├── app.py                    # 主应用入口
├── config.py                 # 配置管理模块
├── logger.py                 # 日志配置模块
├── exceptions.py             # 自定义异常类
├── client_manager.py         # 钉钉Stream客户端管理器
├── handlers/                 # 消息处理器模块
│   ├── __init__.py
│   └── universal_message_handler.py  # 通用消息处理器
├── requirements.txt          # 依赖包列表
├── .env.example             # 环境变量配置模板
└── README.md                # 项目说明文档
```

## 安装依赖

```bash
pip install -r requirements.txt
```

## 配置

1. 复制环境变量示例文件并修改

```bash
cp .env.example .env
```

2. 在`.env`文件中填入您的钉钉应用凭证

```
CLIENT_ID=your_client_id_here
CLIENT_SECRET=your_client_secret_here
LOG_LEVEL=INFO
```

## 运行

```bash
python app.py
```

## 功能说明

本应用实现了以下功能：

-   **通用消息处理**：详细记录和分析所有钉钉消息请求
-   **智能内容识别**：自动识别天气查询等特定类型的请求
-   **详细日志记录**：完整记录请求的所有上下文信息，包括：
    -   原始回调消息数据
    -   HTTP 请求行、头部、主体信息
    -   业务数据分析（用户输入、会话上下文等）
    -   请求处理时间和状态
-   **灵活响应机制**：根据请求内容提供不同类型的响应
-   **错误处理和监控**：完善的异常处理和性能监控
-   **模块化的代码结构**：便于扩展和维护
-   **配置化的参数管理**：集中管理应用配置

### 消息处理详情

应用会详细记录每个请求的以下信息：

1. **原始数据**：完整的钉钉回调消息结构
2. **请求解析**：HTTP 方法、URI、请求头、请求体
3. **业务分析**：
    - 查询参数解析
    - 用户输入字段识别（query、text、message 等）
    - 用户信息提取（user_id、sender 等）
    - 会话上下文分析（context、session_id 等）
4. **处理结果**：响应内容和处理时间统计

### 响应类型

-   **天气查询**：当检测到天气相关关键词时，返回模拟天气信息
-   **回显响应**：默认模式，返回请求的详细分析结果，便于调试和了解钉钉消息结构

## 代码架构特点

### 1. 模块化设计

-   **配置管理**：`config.py` 集中管理所有配置参数
-   **日志系统**：`logger.py` 提供统一的日志配置
-   **异常处理**：`exceptions.py` 定义自定义异常类
-   **客户端管理**：`client_manager.py` 负责钉钉 Stream 客户端的生命周期管理
-   **处理器模块**：`handlers/` 目录包含通用消息处理器，内置模拟数据

### 2. 面向对象设计

-   使用类封装相关功能
-   清晰的职责分离
-   便于单元测试和模拟

### 3. 错误处理

-   分层的异常处理机制
-   详细的错误日志记录
-   优雅的资源清理

### 4. 类型注解

-   完整的类型提示
-   提高代码可读性和 IDE 支持

## 扩展开发

### 添加新的处理器

1. 在 `handlers/` 目录下创建新的处理器文件
2. 继承 `dingtalk_stream.GraphHandler` 基类
3. 实现 `process` 方法
4. 在 `client_manager.py` 中注册新的处理器

### 扩展现有处理器功能

1. 在 `UniversalMessageHandler` 中添加新的数据处理方法
2. 在 `_create_response_based_on_request` 方法中添加新的内容识别逻辑
3. 根据需要扩展内置的模拟数据

您可以根据自己的需求扩展各个模块的功能。
